-- PERFIL DE USUARIO [SUPERVISOR, ESCRAVO]
CREATE TABLE IF NOT EXISTS PERFIL(
ID SERIAL PRIMARY KEY NOT NULL,
DESCRICAO VARCHAR(100)
);

-- USUARIOS
CREATE TABLE IF NOT EXISTS USUARIO(
ID SERIAL PRIMARY KEY NOT NULL,
EMAIL VARCHAR(100) NOT NULL,
NOME VARCHAR(100)NOT NULL,
SENHA TEXT NOT NULL,
PERFIL INTEGER NOT NULL,
CONSTRAINT FK_PERFIL FOREIGN KEY (PERFIL) REFERENCES PERFIL(ID) ON DELETE RESTRICT
);

-- TABELA DE DEFINICAO DA BASE DE IMAGENS CLASSIFICAVEIS
CREATE TABLE IF NOT EXISTS BASE_IMAGEM_CLASSE(
ID SERIAL PRIMARY KEY NOT NULL,
TITULO TEXT NOT NULL,
TEXTO TEXT NOT NULL,
SUPERVISOR INTEGER NOT NULL,
CONSTRAINT FK_SUPERVISOR_BASE FOREIGN KEY (SUPERVISOR) REFERENCES USUARIO(ID) ON DELETE RESTRICT
);

-- TABELA DE DEFINICAO DE IMAGENS CLASSIFICAVEIS
CREATE TABLE IF NOT EXISTS IMAGEM_CLASSE(
ID SERIAL PRIMARY KEY NOT NULL,
OBJETO bytea NOT NULL,
SUPERVISOR INTEGER NOT NULL,
CONSTRAINT FK_SUPERVISOR_IMAGEM_CLASSE FOREIGN KEY (SUPERVISOR) REFERENCES USUARIO(ID) ON DELETE RESTRICT
);

-- TABELA DE ALOCACAO DE IMAGENS PARA UMA BASE
CREATE TABLE IF NOT EXISTS ALOCACAO_IMAGEM_CLASSE(
ID SERIAL PRIMARY KEY NOT NULL,
BASE_IMAGEM_CLASSE INTEGER NOT NULL,
IMAGEM_CLASSE INTEGER NOT NULL,
SUPERVISOR INTEGER NOT NULL,
CONSTRAINT FK_SUPERVISOR_ALOCACAO_IMAGEM_CLASSE FOREIGN KEY (SUPERVISOR) REFERENCES USUARIO(ID) ON DELETE RESTRICT,
CONSTRAINT FK_IMAGEM_CLASSE_ALOCACAO_IMAGEM_CLASSE FOREIGN KEY (IMAGEM_CLASSE) REFERENCES IMAGEM_CLASSE(ID) ON DELETE RESTRICT,
CONSTRAINT FK_BASE_IMAGEM_CLASSE_ALOCACAO_IMAGEM_CLASSE FOREIGN KEY (BASE_IMAGEM_CLASSE) REFERENCES BASE_IMAGEM_CLASSE(ID) ON DELETE RESTRICT
);

-- TABELA DE LIBERACAO DE BASES DE IMAGEM
CREATE TABLE IF NOT EXISTS LIBERACAO_BASE_IMAGEM_CLASSE(
BASE_IMAGEM_CLASSE INTEGER NOT NULL,
SUPERVISOR INTEGER NOT NULL,
ESCRAVO INTEGER NOT NULL,
STATUS BOOLEAN NOT NULL,
CONSTRAINT PK_ID_LIBERACAO_BASE_IMAGEM_CLASSE PRIMARY KEY(BASE_IMAGEM_CLASSE,SUPERVISOR,ESCRAVO),
CONSTRAINT FK_BASE_IMAGEM_CLASSE_LIBERACAO_BASE_IMAGEM_CLASSE FOREIGN KEY (BASE_IMAGEM_CLASSE) REFERENCES BASE_IMAGEM_CLASSE(ID) ON DELETE RESTRICT,
CONSTRAINT FK_SUPERVISOR_LIBERACAO_BASE_IMAGEM_CLASSE FOREIGN KEY (SUPERVISOR) REFERENCES USUARIO(ID) ON DELETE RESTRICT,
CONSTRAINT FK_ESCRAVO_LIBERACAO_BASE_IMAGEM_CLASSE FOREIGN KEY (ESCRAVO) REFERENCES USUARIO(ID) ON DELETE RESTRICT
);

-- TABELA DE ESCOLHA DE CLASSES PARA CLASSIFICACAO DE IMAGENS
CREATE TABLE IF NOT EXISTS ESCOLHA_IMAGEM_CLASSE(
ID SERIAL PRIMARY KEY NOT NULL,
DESCRICAO TEXT NOT NULL,
ALOCACAO_IMAGEM_CLASSE INTEGER NOT NULL,
CONSTRAINT FK_ALOCACAO_IMAGEM_CLASSE_ESCOLHA_IMAGEM_CLASSE FOREIGN KEY (ALOCACAO_IMAGEM_CLASSE) REFERENCES ALOCACAO_IMAGEM_CLASSE(ID) ON DELETE RESTRICT
);

-- TABELA DE CLASSIFICACAO FEITA PELO ESCRAVO
CREATE TABLE IF NOT EXISTS CLASSIFICACAO_IMAGEM_CLASSE(
ESCRAVO INTEGER NOT NULL,
ALOCACAO_IMAGEM_CLASSE INTEGER NOT NULL,
ESCOLHA_IMAGEM_CLASSE INTEGER NOT NULL,
CONSTRAINT PK_ID_CLASSIFICACAO_IMAGEM_CLASSE PRIMARY KEY(ESCRAVO, ALOCACAO_IMAGEM_CLASSE,ESCOLHA_IMAGEM_CLASSE),
CONSTRAINT FK_ESCRAVO_CLASSIFICACAO_IMAGEM_CLASSE FOREIGN KEY (ESCRAVO) REFERENCES USUARIO(ID) ON DELETE RESTRICT,
CONSTRAINT FK_ALOCACAO_IMAGEM_CLASSE_CLASSIFICACAO_IMAGEM_CLASSE FOREIGN KEY (ALOCACAO_IMAGEM_CLASSE) REFERENCES ALOCACAO_IMAGEM_CLASSE(ID) ON DELETE RESTRICT,
CONSTRAINT FK_ESCOLHA_IMAGEM_CLASSE_CLASSIFICACAO_IMAGEM_CLASSE FOREIGN KEY (ESCOLHA_IMAGEM_CLASSE) REFERENCES ESCOLHA_IMAGEM_CLASSE(ID) ON DELETE RESTRICT
);

-- VIEW DE VOTACAO DE IMAGENS
CREATE VIEW BASE_IMAGEM_CLASSIFICADA
AS
SELECT 
  "ESCRAVO".nome AS "ESCRAVO", 
  "SUPERVISOR".nome AS "SUPERVISOR", 
  "IMAGEM".objeto AS "IMAGEM", 
  "CLASSE".descricao AS "CLASSE"
FROM 
  public.usuario "ESCRAVO", 
  public.usuario "SUPERVISOR", 
  public.imagem_classe "IMAGEM", 
  public.classificacao_imagem_classe "CLASSIFICACAO", 
  public.liberacao_base_imagem_classe, 
  public.escolha_imagem_classe "CLASSE"
WHERE 
  "ESCRAVO".id = "CLASSIFICACAO".escravo AND
  "CLASSIFICACAO".alocacao_imagem_classe = "IMAGEM".id AND
  liberacao_base_imagem_classe.supervisor = "SUPERVISOR".id AND
  liberacao_base_imagem_classe.escravo = "CLASSIFICACAO".escravo AND
  "CLASSE".id = "CLASSIFICACAO".escolha_imagem_classe;

